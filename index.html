<!doctype html>
<html lang="ru">
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sleepagotchi ‚Äî Clan Wars Leaderboard</title>

<style>
  /* ==== –ü–ê–õ–ò–¢–†–ê: –ø–æ–¥–≥–æ–Ω–∏ –ø–æ–¥ gocollect.sleepagotchi.com ==== */
  :root{
    --bg: #0a0f14;          /* —Ñ–æ–Ω —Å—Ç—Ä–∞–Ω–∏—Ü—ã */
    --fg: #eaf2ff;          /* –æ—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–∫—Å—Ç */
    --muted:#9fb1c6;        /* –≤—Ç–æ—Ä–∏—á–Ω—ã–π —Ç–µ–∫—Å—Ç */
    --card:#0f1720;         /* –∫–∞—Ä—Ç–æ—á–∫–∏/—è—á–µ–π–∫–∏ */
    --border:#1d2a3a;       /* –≥—Ä–∞–Ω–∏—Ü—ã */
    --primary:#00e6a8;      /* –æ—Å–Ω–æ–≤–Ω–æ–π –∞–∫—Ü–µ–Ω—Ç (–Ω–µ–æ–Ω–æ–≤—ã–π –º—è—Ç–Ω—ã–π) */
    --secondary:#6c5ce7;    /* –≤—Ç–æ—Ä–æ–π –∞–∫—Ü–µ–Ω—Ç (–∏–Ω–¥–∏–≥–æ/—Ñ–∏–æ–ª–µ—Ç) */
    --grad1:#0b1220;        /* –≥—Ä–∞–¥–∏–µ–Ω—Ç 1 */
    --grad2:#101a2b;        /* –≥—Ä–∞–¥–∏–µ–Ω—Ç 2 */
  }
  /* —Å–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞ –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ */
  :root.light{
    --bg:#ffffff; --fg:#0a0f14; --muted:#5a6a7c; --card:#f5f8fc; --border:#e4ecf5;
    --grad1:#ffffff; --grad2:#f7fbff;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background: radial-gradient(1200px 600px at 20% -10%, var(--grad2), transparent 70%) , linear-gradient(var(--grad1), var(--bg));
    color:var(--fg); font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  }
  .wrap{max-width:1200px; margin:32px auto; padding:0 16px}
  header{display:flex; gap:16px; align-items:center; justify-content:space-between; margin-bottom:16px}
  .title{display:flex; gap:12px; align-items:center}
  .badge{font-size:12px; padding:4px 8px; border:1px solid var(--border); border-radius:999px; color:var(--muted)}
  h1{font-size:22px; margin:0}
  .muted{color:var(--muted)}
  .controls{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
  input[type="search"], select, button{
    padding:10px 12px; border:1px solid var(--border); background:var(--card); color:var(--fg);
    border-radius:10px; outline:none
  }
  button{cursor:pointer}
  .pill{background:linear-gradient(135deg, var(--primary), var(--secondary)); color:#001a12; font-weight:600; border:none}
  .cards{display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:12px; margin:16px 0}
  .card{background:rgba(15,23,32,.7); backdrop-filter: blur(6px); border:1px solid var(--border); border-radius:16px; padding:14px}
  .k{font-size:12px; color:var(--muted)}
  .v{font-size:22px; font-weight:700}
  .accent{background:linear-gradient(135deg, rgba(0,230,168,.15), rgba(108,92,231,.15)); border-color:rgba(0,230,168,.35)}

  table{width:100%; border-collapse:collapse}
  thead th{position:sticky; top:0; background:var(--card); border-bottom:1px solid var(--border)}
  th,td{padding:10px 12px; border-bottom:1px solid var(--border); white-space:nowrap}
  th.sortable{cursor:pointer}
  tbody tr:hover td{background:rgba(255,255,255,.03)}
  .right{text-align:right}
  .center{text-align:center}

  .panel{display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:14px 0}
  .spacer{flex:1}
  .pager{display:flex; gap:8px; align-items:center}
  .chip{border:1px solid var(--border); border-radius:8px; padding:6px 10px; color:var(--muted)}
  .foot{margin-top:18px; color:var(--muted); font-size:12px}
</style>

<body>
<div class="wrap">

  <header>
    <div class="title">
      <span class="badge">Event</span>
      <div>
        <h1>Go Collect ‚Äî Clan Wars</h1>
        <div class="muted">–õ–∏–¥–µ—Ä–±–æ—Ä–¥. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–∞–∑ –≤ —á–∞—Å</div>
      </div>
    </div>
    <div class="controls">
      <input id="q" type="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ userId / —Ñ–∏–ª—å—Ç—Ä‚Ä¶" />
      <select id="pagesize"><option>25</option><option selected>50</option><option>100</option></select>
      <button id="theme">üåì –¢–µ–º–∞</button>
      <button id="refresh" class="pill">–û–±–Ω–æ–≤–∏—Ç—å</button>
    </div>
  </header>

  <!-- —Å—á—ë—Ç—á–∏–∫–∏ —Å–≤–µ—Ä—Ö—É -->
  <div class="cards">
    <div class="card accent"><div class="k">–í—Å–µ–≥–æ –∏–≥—Ä–æ–∫–æ–≤</div><div class="v" id="m_total">‚Äî</div></div>
    <div class="card"><div class="k">–°—Ä–µ–¥–Ω–∏–π Score</div><div class="v" id="m_avg">‚Äî</div></div>
    <div class="card"><div class="k">–ú–∞–∫—Å Score</div><div class="v" id="m_max">‚Äî</div></div>
    <div class="card"><div class="k">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</div><div class="v" id="m_time">‚Äî</div></div>
  </div>

  <div class="card" style="padding:0; overflow:hidden">
    <table id="tbl">
      <thead><tr id="head"></tr></thead>
      <tbody id="body"><tr><td class="center" colspan="10">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</td></tr></tbody>
    </table>
  </div>

  <div class="panel">
    <span class="chip" id="meta">‚Äî</span>
    <div class="spacer"></div>
    <div class="pager">
      <button id="prev">‚Üê</button>
      <span class="chip" id="pageinfo">1 / 1</span>
      <button id="next">‚Üí</button>
    </div>
  </div>

  <div class="foot">–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö: <code>leaderboard.csv</code> –≤ –∫–æ—Ä–Ω–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è GitHub Pages.</div>
</div>

<script>
/* ===== theme toggle ===== */
const root = document.documentElement;
const saved = localStorage.getItem('theme') || 'dark';
if(saved==='light') root.classList.add('light');
document.getElementById('theme').onclick = ()=>{
  root.classList.toggle('light');
  localStorage.setItem('theme', root.classList.contains('light')?'light':'dark');
};

/* ===== —Ç–∞–±–ª–∏—Ü–∞ ===== */
let rows=[], headers=[], filtered=[], sortKey=0, sortDir=1, page=1, pageSize=50;
const headEl = document.getElementById('head');
const bodyEl = document.getElementById('body');
const pageInfo = document.getElementById('pageinfo');
const meta = document.getElementById('meta');

async function loadCSV(){
  const res = await fetch('leaderboard.csv?cache='+Date.now());
  if(!res.ok){ bodyEl.innerHTML = `<tr><td class="center" colspan="10">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å CSV</td></tr>`; return; }
  const txt = await res.text();
  const lines = txt.trim().split(/\r?\n/).map(l => l.split(','));
  headers = lines.shift();
  rows = lines.map(r => r.map(c => c));
  renderHead();
  apply();
  updateMetrics();
}
function renderHead(){
  headEl.innerHTML = headers.map((h,i)=>`<th class="sortable" data-i="${i}">${h} ${i===sortKey?(sortDir>0?'‚ñ≤':'‚ñº'):''}</th>`).join('');
  headEl.querySelectorAll('.sortable').forEach(th=>{
    th.onclick = ()=>{
      const i = +th.dataset.i;
      if(sortKey===i) sortDir*=-1; else { sortKey=i; sortDir=1; }
      page=1; apply();
    };
  });
}
function apply(){
  const q = document.getElementById('q').value.trim().toLowerCase();
  filtered = q ? rows.filter(r => r.some(c => (c+'').toLowerCase().includes(q))) : [...rows];

  filtered.sort((a,b)=>{
    const av=a[sortKey], bv=b[sortKey];
    const na=+av, nb=+bv, bothNum = !isNaN(na)&&!isNaN(nb);
    const res = bothNum ? (na-nb) : (''+av).localeCompare(''+bv,'ru',{numeric:true});
    return res*sortDir;
  });

  pageSize = +document.getElementById('pagesize').value;
  const total = filtered.length, maxPage = Math.max(1, Math.ceil(total/pageSize));
  page = Math.min(page, maxPage);
  const start=(page-1)*pageSize, end=start+pageSize, slice=filtered.slice(start,end);

  bodyEl.innerHTML = slice.map(r => `<tr>${r.map((c,i)=>`<td class="${i>0?'right':''}">${c}</td>`).join('')}</tr>`).join('')
                      || `<tr><td class="center" colspan="${headers.length}">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>`;
  pageInfo.textContent = `${page} / ${maxPage}`;
  meta.textContent = `–ü–æ–∫–∞–∑–∞–Ω–æ ${slice.length} –∏–∑ ${total}`;
}
function updateMetrics(){
  const scoreIdx = headers.findIndex(h => h.toLowerCase() === 'score' || h.toLowerCase() === '"score"');
  const ids = new Set(rows.map(r => r[0]));
  document.getElementById('m_total').textContent = ids.size.toString();
  if(scoreIdx>=0){
    const nums = rows.map(r => +r[scoreIdx]).filter(n => !isNaN(n));
    const avg = nums.length ? (nums.reduce((a,b)=>a+b,0)/nums.length) : 0;
    const max = nums.length ? Math.max(...nums) : 0;
    document.getElementById('m_avg').textContent = Math.round(avg);
    document.getElementById('m_max').textContent = max;
  } else {
    document.getElementById('m_avg').textContent = '‚Äî';
    document.getElementById('m_max').textContent = '‚Äî';
  }
  const now = new Date(); 
  document.getElementById('m_time').textContent = now.toLocaleString();
}

/* —Å–æ–±—ã—Ç–∏—è UI */
document.getElementById('q').oninput = ()=>{ page=1; apply(); };
document.getElementById('pagesize').onchange = ()=>{ page=1; apply(); };
document.getElementById('prev').onclick = ()=>{ if(page>1){ page--; apply(); } };
document.getElementById('next').onclick = ()=>{ const max=Math.ceil((filtered.length||1)/pageSize)||1; if(page<max){ page++; apply(); } };
document.getElementById('refresh').onclick = loadCSV;

/* –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ csv –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ (–º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å 60*1000) */
setInterval(loadCSV, 5*60*1000);
loadCSV();
</script>
</body>
</html>
