<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Clan Wars Leaderboard</title>
<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #0b0f1a;
        color: #fff;
        margin: 0;
        padding: 0;
    }
    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }
    th, td {
        padding: 8px 12px;
        text-align: center;
    }
    th {
        background-color: #1f2937;
    }
    details.card > summary {
        list-style: none;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 12px;
        padding: 12px 16px;
        cursor: pointer;
        user-select: none;
        background: linear-gradient(90deg, rgba(123,63,242,0.6), rgba(167,139,250,0.6));
        font-weight: 800;
        letter-spacing: .2px;
    }
    .clan-name {
        color: #ffa500; /* оранжевый */
        font-size: 1.2em;
        font-weight: 900;
    }
    .timestamp {
        font-size: 0.9em;
        color: #ccc;
        margin: 10px 0;
        text-align: center;
    }
</style>
</head>
<body>

<div class="timestamp" id="timestamp"></div>
<div id="leaderboard"></div>

<script>
async function loadData() {
    const response = await fetch('leaderboard.csv');
    const csvText = await response.text();
    const rows = csvText.trim().split('\n').map(r => r.split(','));
    const headers = rows.shift();
    const data = rows.map(r => Object.fromEntries(headers.map((h, i) => [h, r[i]])));

    const clans = {};
    data.forEach(row => {
        if (row.kind === 'clan') {
            clans[row.clan] = { rank: row.clan_rank, total: row.clan_result_total, players: [] };
        } else if (row.kind === 'player') {
            clans[row.clan].players.push({
                name: row.userId,
                rank: row.player_rank,
                result: row.player_result
            });
        }
    });

    const container = document.getElementById('leaderboard');
    container.innerHTML = '';
    Object.entries(clans).sort((a,b) => a[1].rank - b[1].rank).forEach(([clan, data]) => {
        const details = document.createElement('details');
        details.classList.add('card');
        const summary = document.createElement('summary');
        summary.innerHTML = `
            <div class="clan-name">#${data.rank} ${clan}</div>
            <div>Clan Total vSleep: ${data.total}</div>
        `;
        details.appendChild(summary);

        const table = document.createElement('table');
        table.innerHTML = `
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Player Name</th>
                    <th>vSleep</th>
                </tr>
            </thead>
            <tbody>
                ${data.players.map(p => `
                    <tr>
                        <td>${p.rank}</td>
                        <td>${p.name}</td>
                        <td>${p.result}</td>
                    </tr>
                `).join('')}
            </tbody>
        `;
        details.appendChild(table);
        container.appendChild(details);
    });
}

function updateTimestamp() {
    fetch('leaderboard.csv', { method: 'HEAD' })
        .then(res => {
            const lastModified = res.headers.get('Last-Modified');
            if (lastModified) {
                const lastDate = new Date(lastModified);
                const diffMs = Date.now() - lastDate.getTime();
                const diffMins = Math.floor(diffMs / 60000);
                document.getElementById('timestamp').textContent = `Updated ${diffMins} minutes ago`;
            }
        });
}

loadData();
updateTimestamp();
</script>

</body>
</html>
