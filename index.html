<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sleepagotchi ‚Äî Clan Wars Leaderboard</title>
<style>
  /* ===== Theme (tweak to match your brand) ===== */
  :root{
    --bg:#0a0f14;          /* page background */
    --fg:#eaf2ff;          /* primary text */
    --muted:#9fb1c6;       /* secondary text */
    --card:#101826;        /* cards/cells */
    --border:#1d2a3a;      /* borders */
    --primary:#00e6a8;     /* accent */
    --secondary:#6c5ce7;   /* accent 2 */
  }
  :root.light{
    --bg:#ffffff; --fg:#0a0f14; --muted:#5a6a7c; --card:#f5f8fc; --border:#e4ecf5;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:
      radial-gradient(1200px 600px at 20% -10%, rgba(108,92,231,.12), transparent 70%),
      linear-gradient(#0b1220, var(--bg));
    color:var(--fg);
    font:14px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
  }
  .wrap{max-width:1100px;margin:32px auto;padding:0 16px}

  header{display:flex;gap:16px;align-items:center;justify-content:space-between;margin-bottom:16px}
  h1{font-size:22px;margin:0}
  .muted{color:var(--muted)}
  .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input[type="search"], select, button{
    padding:10px 12px;border:1px solid var(--border);background:var(--card);color:var(--fg);
    border-radius:10px;outline:none
  }
  button{cursor:pointer}
  .pill{background:linear-gradient(135deg, var(--primary), var(--secondary));border:none;color:#001a12;font-weight:600}

  .card{background:rgba(16,24,38,.8);backdrop-filter:blur(6px);border:1px solid var(--border);border-radius:14px}
  details.card{margin:10px 0;overflow:hidden}
  details.card > summary{
    list-style:none;
    display:flex;justify-content:space-between;align-items:center;gap:12px;
    padding:12px 16px; cursor:pointer; user-select:none;
  }
  details.card[open] > summary{border-bottom:1px solid var(--border)}
  summary::-webkit-details-marker{display:none}
  .clan-title{display:flex;gap:10px;align-items:center}
  .rank{display:inline-block;min-width:40px;text-align:center;font-weight:700}
  .badge{font-size:12px;padding:2px 8px;border:1px solid var(--border);border-radius:999px;color:var(--muted)}
  .total{opacity:.9}

  table{width:100%;border-collapse:collapse}
  th,td{padding:10px 12px;border-bottom:1px solid var(--border);white-space:nowrap}
  thead th{position:sticky;top:0;background:var(--card)}
  tbody tr:hover td{background:rgba(255,255,255,.03)}
  .right{text-align:right}
  .center{text-align:center}

  .panel{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin:14px 0}
  .spacer{flex:1}
  .chip{border:1px solid var(--border);border-radius:8px;padding:6px 10px;color:var(--muted)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div>
      <h1>Clan Wars ‚Äî Leaderboard</h1>
      <div class="muted">Auto-updates hourly from <code>leaderboard.csv</code></div>
    </div>
    <div class="controls">
      <input id="q" type="search" placeholder="Search clans & players‚Ä¶" />
      <select id="pagesize" title="Clans per page">
        <option>10</option><option selected>20</option><option>50</option>
      </select>
      <button id="theme">üåì Theme</button>
      <button id="refresh" class="pill">Refresh</button>
    </div>
  </header>

  <div class="panel">
    <span class="chip" id="meta">‚Äî</span>
    <div class="spacer"></div>
    <span class="muted">Tip: click a clan row to expand its players</span>
  </div>

  <!-- clans render here -->
  <div id="clans"></div>

  <div class="panel">
    <div class="spacer"></div>
    <button id="prev">‚Üê Previous</button>
    <span class="chip" id="pageinfo">1 / 1</span>
    <button id="next">Next ‚Üí</button>
  </div>
</div>

<script>
/* ===== Theme toggle ===== */
const root = document.documentElement;
const savedTheme = localStorage.getItem('theme') || 'dark';
if (savedTheme === 'light') root.classList.add('light');
document.getElementById('theme').onclick = () => {
  root.classList.toggle('light');
  localStorage.setItem('theme', root.classList.contains('light') ? 'light' : 'dark');
};

/* ===== Data handling ===== */
let orderedClans = []; // [ [clanName, {rank,total,players:[{userId,player_rank,player_result}]}], ... ]
let page = 1, pageSize = 20;
const rootEl = document.getElementById('clans');
const metaEl = document.getElementById('meta');
const pageInfo = document.getElementById('pageinfo');

async function loadCSV(){
  const res = await fetch('leaderboard.csv?cache=' + Date.now());
  if(!res.ok){
    rootEl.innerHTML = '<div class="card" style="padding:16px">Failed to load CSV</div>';
    return;
  }
  const txt = await res.text();

  // very simple CSV parsing (suited for our generated CSV without embedded commas/quotes)
  const lines = txt.trim().split(/\r?\n/).map(r => r.split(','));
  const headers = lines.shift().map(h => h.replace(/^"|"$/g,''));
  const idx = Object.fromEntries(headers.map((h,i)=>[h,i]));
  // expected columns:
  // kind, clan, clan_rank, clan_result_total, userId, player_rank, player_result, order_in_group

  const map = new Map();
  for (const row of lines) {
    const kind = row[idx.kind];
    const clan = row[idx.clan];
    const clan_rank = +row[idx.clan_rank];
    const clan_total = +row[idx.clan_result_total];

    if (!map.has(clan)) map.set(clan, { rank: clan_rank, total: clan_total, players: [] });

    if (kind === 'player') {
      map.get(clan).players.push({
        userId: row[idx.userId],
        player_rank: +row[idx.player_rank],
        player_result: +row[idx.player_result]
      });
    }
  }

  orderedClans = [...map.entries()].sort((a,b)=>a[1].rank - b[1].rank);
  page = 1;
  render();
}

function formatNumber(x){
  const n = Number(x);
  if (Number.isNaN(n)) return x;
  return n.toLocaleString('en-US');
}

function filteredClans(){
  const q = document.getElementById('q').value.trim().toLowerCase();
  if(!q) return orderedClans;

  // filter by clan name or matching player/userId/value
  return orderedClans.filter(([clan, data])=>{
    if (clan.toLowerCase().includes(q)) return true;
    return data.players.some(p =>
      (''+p.userId).toLowerCase().includes(q) ||
      (''+p.player_result).toLowerCase().includes(q) ||
      (''+p.player_rank).toLowerCase().includes(q)
    );
  });
}

function render(){
  const all = filteredClans();
  pageSize = +document.getElementById('pagesize').value;
  const maxPage = Math.max(1, Math.ceil(all.length / pageSize));
  page = Math.min(page, maxPage);

  const slice = all.slice((page-1)*pageSize, (page-1)*pageSize + pageSize);

  rootEl.innerHTML = slice.map(([clan, data])=>{
    const playersRows = (data.players || [])
      .sort((a,b)=>a.player_rank - b.player_rank)
      .map(p => `
        <tr>
          <td class="right" style="width:60px">#${p.player_rank}</td>
          <td>${p.userId}</td>
          <td class="right">${formatNumber(p.player_result)}</td>
        </tr>
      `).join('') || `<tr><td colspan="3" class="center muted">No players</td></tr>`;

    return `
      <details class="card" ${data.rank===1 ? 'open' : ''}>
        <summary>
          <div class="clan-title">
            <span class="rank">#${data.rank}</span>
            <div>
              <div style="font-weight:700">${clan}</div>
              <div class="badge">players: ${data.players.length}</div>
            </div>
          </div>
          <div class="total">Clan total: <strong>${formatNumber(data.total)}</strong></div>
        </summary>
        <div style="padding:10px 16px 14px">
          <table>
            <thead>
              <tr>
                <th class="right">Rank</th>
                <th>Player (userId)</th>
                <th class="right">vSleep</th>
              </tr>
            </thead>
            <tbody>${playersRows}</tbody>
          </table>
        </div>
      </details>
    `;
  }).join('');

  pageInfo.textContent = `${page} / ${Math.max(1, Math.ceil(all.length / pageSize))}`;
  metaEl.textContent = `Clans: ${all.length} ‚Ä¢ Showing: ${slice.length}`;
}

/* ===== UI events ===== */
document.getElementById('q').addEventListener('input', ()=>{ page=1; render(); });
document.getElementById('pagesize').addEventListener('change', ()=>{ page=1; render(); });
document.getElementById('prev').onclick = ()=>{ if(page>1){ page--; render(); } };
document.getElementById('next').onclick = ()=>{ const all = filteredClans(); const max = Math.max(1, Math.ceil(all.length/pageSize)); if(page<max){ page++; render(); } };
document.getElementById('refresh').onclick = loadCSV;

/* ===== Auto refresh (optional) ===== */
setInterval(loadCSV, 5*60*1000); // every 5 minutes
loadCSV();
</script>
</body>
</html>
